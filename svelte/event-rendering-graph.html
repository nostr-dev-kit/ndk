<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Rendering Flow - Graph Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #58a6ff;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #8b949e;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .graph-section {
            background: #161b22;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #30363d;
        }

        .graph-title {
            color: #79c0ff;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #30363d;
        }

        .graph-description {
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .mermaid {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 30px 0;
            padding: 20px;
            background: #0d1117;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #161b22;
            border-radius: 6px;
            border-left: 4px solid;
        }

        .legend-item.recursive { border-left-color: #f0883e; }
        .legend-item.custom { border-left-color: #bc8cff; }
        .legend-item.builtin { border-left-color: #58a6ff; }
        .legend-item.text { border-left-color: #8b949e; }

        .legend-icon {
            font-size: 1.5em;
        }

        .legend-text {
            flex: 1;
        }

        .legend-label {
            color: #c9d1d9;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .legend-desc {
            color: #8b949e;
            font-size: 0.9em;
        }

        .info-box {
            background: linear-gradient(135deg, #1f6feb 0%, #58a6ff 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 2px solid #30363d;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: #58a6ff;
        }

        .tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .code-block {
            background: #0d1117;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 12px 0;
            border-left: 4px solid #58a6ff;
        }

        .highlight {
            color: #f0883e;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Event Rendering Flow Graph</h1>
        <div class="subtitle">Complete visual representation of all rendering paths and components</div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item recursive">
                <span class="legend-icon">üîÑ</span>
                <div class="legend-text">
                    <div class="legend-label">Recursive Path</div>
                    <div class="legend-desc">Fetches data and can trigger nested rendering</div>
                </div>
            </div>
            <div class="legend-item custom">
                <span class="legend-icon">üé®</span>
                <div class="legend-text">
                    <div class="legend-label">Customizable</div>
                    <div class="legend-desc">Can provide custom component via renderer</div>
                </div>
            </div>
            <div class="legend-item builtin">
                <span class="legend-icon">‚öôÔ∏è</span>
                <div class="legend-text">
                    <div class="legend-label">Built-in Only</div>
                    <div class="legend-desc">Always uses default rendering</div>
                </div>
            </div>
            <div class="legend-item text">
                <span class="legend-icon">üìù</span>
                <div class="legend-text">
                    <div class="legend-label">Pass-through</div>
                    <div class="legend-desc">No processing, rendered as-is</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('detailed')">Detailed Flow</button>
            <button class="tab" onclick="showTab('recursive')">Recursive Example</button>
            <button class="tab" onclick="showTab('customization')">Customization Points</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="graph-section">
                <div class="graph-title">üìä High-Level Architecture</div>
                <div class="graph-description">
                    This shows the main component hierarchy and how events flow through the system from entry point to final rendering.
                </div>
                <div class="mermaid">
graph TB
    Start([User Renders Event]) --> ECC[EventCardClassic<br/>Optional Composition]
    ECC --> ECRoot[EventCard.Root<br/>Context Provider]
    ECRoot --> ECContent[EventCard.Content<br/>Truncation + Bridge]
    ECContent --> EventContent[EventContent<br/>MAIN ROUTER]

    EventContent --> Parse[Parse Content<br/>utils.ts]
    Parse --> Segments[10 Segment Types]

    Segments --> Text[1. Text<br/>Pass-through]
    Segments --> EventRef[2. Event Ref<br/>üîÑ Recursive]
    Segments --> Npub[3. npub<br/>üé® Custom]
    Segments --> Nprofile[4. nprofile<br/>üé® Custom]
    Segments --> Link[5. Link<br/>üé® Custom]
    Segments --> LinkGroup[6. Link Group<br/>üé® Custom]
    Segments --> Media[7. Media<br/>üé® Custom]
    Segments --> ImageGrid[8. Image Grid<br/>üé® Custom]
    Segments --> Hashtag[9. Hashtag<br/>üé® Custom]
    Segments --> Emoji[10. Emoji<br/>‚öôÔ∏è Built-in]

    EventRef --> EmbedEvent[EmbeddedEvent<br/>Fetch + Dispatch]
    EmbedEvent --> KindHandler[Kind Handler<br/>NoteEmbedded, etc]
    KindHandler --> ECRoot

    Npub --> Mention[MentionComponent<br/>or raw text]
    Nprofile --> Mention
    Link --> LinkComp[LinkComponent<br/>or &lt;a&gt; tag]
    LinkGroup --> LinkComp
    Media --> MediaComp[MediaComponent<br/>or &lt;img&gt;/&lt;video&gt;]
    ImageGrid --> MediaComp
    Hashtag --> HashtagComp[HashtagComponent<br/>or #tag]
    Emoji --> EmojiImg[&lt;img&gt; tag]

    style EventContent fill:#1f6feb,stroke:#58a6ff,stroke-width:4px,color:#fff
    style EventRef fill:#f0883e,stroke:#d2691e,stroke-width:3px,color:#fff
    style Npub fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style Nprofile fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style Link fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style LinkGroup fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style Media fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style ImageGrid fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style Hashtag fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style Text fill:#8b949e,stroke:#6e7681,stroke-width:2px,color:#fff
    style Emoji fill:#238636,stroke:#2ea043,stroke-width:2px,color:#fff
                </div>
            </div>
        </div>

        <!-- Detailed Flow Tab -->
        <div id="detailed" class="tab-content">
            <div class="graph-section">
                <div class="graph-title">üîç Detailed Component Flow</div>
                <div class="graph-description">
                    This shows the exact component structure with file locations and line numbers for each rendering path.
                </div>
                <div class="mermaid">
graph TB
    subgraph Entry["üöÄ Entry Point"]
        ECC["EventCardClassic<br/>event-card-classic.svelte:43-67<br/>Optional pre-composed layout"]
    end

    subgraph Context["üì¶ Context Layer"]
        ECRoot["EventCard.Root<br/>event-card-root.svelte:44<br/>setContext(ndk, event)"]
        ECContent["EventCard.Content<br/>event-card-content.svelte:33-90<br/>getContext + truncation UI"]
    end

    subgraph Router["üéØ Main Router"]
        EventContent["EventContent<br/>event-content.svelte:43-138<br/>Parse & route to 10 paths"]
    end

    subgraph Parsing["‚öôÔ∏è Parsing Engine"]
        Parse["parseContentToSegments()<br/>utils.ts:171-217"]
        Classify["classifyMatch()<br/>utils.ts:115-150"]
        Group["grouping functions<br/>utils.ts:227-323"]
    end

    subgraph Recursive["üîÑ Recursive Path"]
        EmbedEvent["EmbeddedEvent<br/>embedded-event.svelte:28-53<br/>Fetch + kind lookup"]
        Registry["ContentRenderer<br/>content-renderer.svelte.ts:176<br/>getKindHandler()"]
        NoteEmbed["NoteEmbedded<br/>note-embedded.svelte:17-27<br/>Renders EventCard.Root"]
    end

    subgraph Custom["üé® Customizable Paths"]
        Mention["MentionComponent<br/>mention.svelte:18-26<br/>Fetch user + render @name"]
        LinkComp["LinkComponent<br/>Custom or &lt;a&gt; tag<br/>Line 68-77"]
        MediaComp["MediaComponent<br/>Custom or &lt;img&gt;/&lt;video&gt;<br/>Line 78-103"]
        HashtagComp["HashtagComponent<br/>Custom or #tag<br/>Line 59-67"]
    end

    subgraph Builtin["‚öôÔ∏è Built-in Paths"]
        TextRender["Plain Text<br/>Line 44-45"]
        EmojiRender["Emoji &lt;img&gt;<br/>Line 104-107"]
    end

    ECC --> ECRoot
    ECRoot --> ECContent
    ECContent --> EventContent

    EventContent --> Parse
    Parse --> Classify
    Classify --> Group
    Group --> EventContent

    EventContent -->|"event-ref"| EmbedEvent
    EventContent -->|"npub/nprofile"| Mention
    EventContent -->|"link/link-group"| LinkComp
    EventContent -->|"media/image-grid"| MediaComp
    EventContent -->|"hashtag"| HashtagComp
    EventContent -->|"text"| TextRender
    EventContent -->|"emoji"| EmojiRender

    EmbedEvent --> Registry
    Registry --> NoteEmbed
    NoteEmbed --> ECRoot

    style EventContent fill:#1f6feb,stroke:#58a6ff,stroke-width:4px,color:#fff
    style EmbedEvent fill:#f0883e,stroke:#d2691e,stroke-width:3px,color:#fff
    style Mention fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style LinkComp fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style MediaComp fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style HashtagComp fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
                </div>
            </div>
        </div>

        <!-- Recursive Example Tab -->
        <div id="recursive" class="tab-content">
            <div class="graph-section">
                <div class="graph-title">üîÑ Recursive Rendering Example</div>
                <div class="graph-description">
                    This shows how nested events are rendered recursively. Event A contains an embedded Event B, which contains a mention of User C.
                </div>

                <div class="code-block">
                    <div><span class="highlight">Event A (kind 1):</span> "Check out this note nostr:nevent1[B] and follow nostr:npub1[C]"</div>
                    <div style="margin-top: 8px;"><span class="highlight">Event B (kind 1):</span> "Hello nostr:npub1[D]!"</div>
                </div>

                <div class="mermaid">
graph TB
    subgraph Level1["Level 1: Root Event"]
        A1[EventCardClassic<br/>renders Event A]
        A2[EventContent parses:<br/>'Check out this note']
        A3[EmbeddedEvent<br/>bech32=nevent1B]
        A4[Mention<br/>bech32=npub1C]
    end

    subgraph Level2["Level 2: Embedded Event B"]
        B1[EmbeddedEvent fetches Event B]
        B2[Registry looks up kind 1<br/>‚Üí NoteEmbedded]
        B3[NoteEmbedded renders<br/>EventCard.Root]
        B4[EventContent parses:<br/>'Hello']
        B5[Mention<br/>bech32=npub1D]
    end

    subgraph Level3["Level 3: User Fetching"]
        C1[Mention fetches User C<br/>Renders @username_c]
        D1[Mention fetches User D<br/>Renders @username_d]
    end

    A1 --> A2
    A2 --> A3
    A2 --> A4
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B4 --> B5
    A4 --> C1
    B5 --> D1

    style A1 fill:#1f6feb,stroke:#58a6ff,stroke-width:2px,color:#fff
    style A3 fill:#f0883e,stroke:#d2691e,stroke-width:3px,color:#fff
    style B1 fill:#f0883e,stroke:#d2691e,stroke-width:3px,color:#fff
    style B3 fill:#1f6feb,stroke:#58a6ff,stroke-width:2px,color:#fff
    style A4 fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style B5 fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
                </div>

                <div class="info-box">
                    <strong>üîÑ Key Insight:</strong> NoteEmbedded (Level 2) renders another EventCard.Root, which creates a new EventCard.Content, which calls EventContent again. This is how infinite nesting is achieved - NoteEmbedded uses the same EventCard system that rendered it!
                </div>
            </div>
        </div>

        <!-- Customization Tab -->
        <div id="customization" class="tab-content">
            <div class="graph-section">
                <div class="graph-title">üé® Customization Architecture</div>
                <div class="graph-description">
                    This shows how the ContentRenderer registry system works and what can be customized at each layer.
                </div>
                <div class="mermaid">
graph TB
    subgraph Registry["üìö ContentRenderer Registry"]
        Default["defaultContentRenderer<br/>Global singleton instance"]

        subgraph Inline["Inline Handlers (4)"]
            PropM["mentionComponent<br/>null by default"]
            PropH["hashtagComponent<br/>null by default"]
            PropL["linkComponent<br/>null by default"]
            PropMedia["mediaComponent<br/>null by default"]
        end

        subgraph Kinds["Kind Registry (Map)"]
            K1["Kind 1, 1111<br/>‚Üí NoteEmbedded"]
            K30023["Kind 30023<br/>‚Üí ArticleEmbedded"]
            K9802["Kind 9802<br/>‚Üí HighlightEmbedded"]
        end
    end

    subgraph Usage["üîß How It's Used"]
        Import["Component imports<br/>trigger registration"]
        SelfReg["Self-registration pattern<br/>addKind([1, 1111], Component)"]

        EC["EventContent checks:<br/>renderer.mentionComponent"]
        EE["EmbeddedEvent checks:<br/>renderer.getKindHandler(kind)"]
    end

    subgraph Custom["‚ú® Your Custom Components"]
        YourMention["Your MentionComponent<br/>Custom user cards"]
        YourLink["Your LinkComponent<br/>Link previews"]
        YourMedia["Your MediaComponent<br/>Lightbox gallery"]
        YourHash["Your HashtagComponent<br/>Clickable tags"]
        YourKind["Your KindHandler<br/>Custom event types"]
    end

    Import --> SelfReg
    SelfReg --> K1
    SelfReg --> K30023
    SelfReg --> K9802

    YourMention --> PropM
    YourLink --> PropL
    YourMedia --> PropMedia
    YourHash --> PropH
    YourKind --> Kinds

    PropM --> EC
    PropH --> EC
    PropL --> EC
    PropMedia --> EC

    K1 --> EE
    K30023 --> EE
    K9802 --> EE

    Default --> Inline
    Default --> Kinds

    style Default fill:#1f6feb,stroke:#58a6ff,stroke-width:4px,color:#fff
    style YourMention fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style YourLink fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style YourMedia fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style YourHash fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
    style YourKind fill:#8957e5,stroke:#bc8cff,stroke-width:2px,color:#fff
                </div>

                <div class="code-block">
                    <div><span class="highlight">// Setup custom components:</span></div>
                    <div>import { defaultContentRenderer } from '$lib/ui';</div>
                    <div>import MyMention from './MyMention.svelte';</div>
                    <div>import MyLinkPreview from './MyLinkPreview.svelte';</div>
                    <div style="margin-top: 8px;">defaultContentRenderer.mentionComponent = MyMention;</div>
                    <div>defaultContentRenderer.linkComponent = MyLinkPreview;</div>
                    <div style="margin-top: 8px;"><span class="highlight">// Register custom event kind:</span></div>
                    <div>import MyCustomEventHandler from './MyCustomEventHandler.svelte';</div>
                    <div>defaultContentRenderer.addKind([42069], MyCustomEventHandler);</div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="graph-section" style="margin-top: 40px;">
            <div class="graph-title">üìä Architecture Summary</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="text-align: center; padding: 30px; background: #0d1117; border-radius: 8px;">
                    <div style="font-size: 3em; color: #58a6ff; font-weight: bold; margin-bottom: 12px;">5</div>
                    <div style="color: #8b949e; font-size: 1.1em;">Core Components</div>
                    <div style="color: #6e7681; font-size: 0.9em; margin-top: 8px;">EventContent, EmbeddedEvent, ContentRenderer, Parsing Utils, Kind Handlers</div>
                </div>
                <div style="text-align: center; padding: 30px; background: #0d1117; border-radius: 8px;">
                    <div style="font-size: 3em; color: #bc8cff; font-weight: bold; margin-bottom: 12px;">4</div>
                    <div style="color: #8b949e; font-size: 1.1em;">Customization Points</div>
                    <div style="color: #6e7681; font-size: 0.9em; margin-top: 8px;">mention, hashtag, link, media components can be replaced</div>
                </div>
                <div style="text-align: center; padding: 30px; background: #0d1117; border-radius: 8px;">
                    <div style="font-size: 3em; color: #f0883e; font-weight: bold; margin-bottom: 12px;">1</div>
                    <div style="color: #8b949e; font-size: 1.1em;">Recursive Path</div>
                    <div style="color: #6e7681; font-size: 0.9em; margin-top: 8px;">EmbeddedEvent ‚Üí Kind Handler ‚Üí EventCard ‚Üí EventContent (loop)</div>
                </div>
                <div style="text-align: center; padding: 30px; background: #0d1117; border-radius: 8px;">
                    <div style="font-size: 3em; color: #58a6ff; font-weight: bold; margin-bottom: 12px;">10</div>
                    <div style="color: #8b949e; font-size: 1.1em;">Content Segment Types</div>
                    <div style="color: #6e7681; font-size: 0.9em; margin-top: 8px;">text, event-ref, npub, nprofile, link, link-group, media, image-grid, hashtag, emoji</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            }
        });

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
