{"name":"article-content","type":"registry:component","title":"Article Content","description":"Render NIP-23 article content with markdown support, inline highlights, text selection, and floating avatars","registryDependencies":[],"dependencies":["@nostr-dev-kit/ndk","@nostr-dev-kit/svelte","marked@^16.4.1"],"files":[{"content":"<!-- @ndk-version: article-content@0.3.0 -->\n<script lang=\"ts\">\n  import { marked } from 'marked';\n  import { NDKHighlight, NDKKind, type NDKArticle } from '@nostr-dev-kit/ndk';\n  import type { NDKSvelte } from '@nostr-dev-kit/svelte';\n  import { SvelteMap } from 'svelte/reactivity';\n  import { getNDKFromContext } from '../../utils/ndk-context.svelte.js';\n  import { User } from '../../ui/user';\n  import HighlightToolbar from './highlight-toolbar.svelte';\n\n  interface Props {\n    ndk?: NDKSvelte;\n    article: NDKArticle;\n    highlightFilter?: (highlight: NDKHighlight) => boolean;\n    onHighlightClick?: (highlight: NDKHighlight) => void;\n    class?: string;\n  }\n\n  let {\n    ndk: providedNdk,\n    article,\n    highlightFilter,\n    onHighlightClick,\n    class: className = ''\n  }: Props = $props();\n\n  const ndk = getNDKFromContext(providedNdk);\n\n  let contentElement = $state<HTMLDivElement>();\n  let avatarData = $state<Array<{ pubkey: string; top: number; right: string }>>([]);\n\n  // Text selection state\n  let showHighlightToolbar = $state(false);\n  let selectedText = $state('');\n  let selectedRange = $state<Range | null>(null);\n\n  // Subscribe to highlights for this article\n  const highlightsSubscription = ndk.$subscribe<NDKHighlight>(() => {\n    if (!article) return undefined;\n    return {\n      filters: {\n        kinds: [NDKKind.Highlight],\n        '#a': [article.tagId()]\n      },\n      subId: 'article-highlights',\n      wrap: true\n    };\n  });\n\n  const highlights = $derived.by(() => {\n    const allHighlights = highlightsSubscription.events;\n    if (!highlightFilter) return allHighlights;\n    return allHighlights.filter(h => highlightFilter(h));\n  });\n\n  const content = $derived(article.content);\n\n  const hasMarkdown = $derived.by(() => {\n    const markdownPatterns = [\n      /^#{1,6}\\s/m,\n      /\\*\\*[^*]+\\*\\*/,\n      /\\*[^*]+\\*/,\n      /\\[([^\\]]+)\\]\\([^)]+\\)/,\n      /^[-*+]\\s/m,\n      /^>\\s/m,\n      /```[\\s\\S]*?```/,\n      /^\\d+\\.\\s/m,\n    ];\n    return markdownPatterns.some(pattern => pattern.test(content));\n  });\n\n  const htmlContent = $derived.by(() => {\n    if (hasMarkdown) {\n      return marked.parse(content);\n    }\n    return content;\n  });\n\n  function handleMouseUp() {\n    const selection = window.getSelection();\n    if (!selection || selection.isCollapsed) {\n      showHighlightToolbar = false;\n      return;\n    }\n\n    const text = selection.toString().trim();\n    if (text.length === 0) {\n      showHighlightToolbar = false;\n      return;\n    }\n\n    // Check if selection is within the article content\n    if (!contentElement?.contains(selection.anchorNode)) {\n      showHighlightToolbar = false;\n      return;\n    }\n\n    const range = selection.getRangeAt(0);\n\n    selectedText = text;\n    selectedRange = range;\n    showHighlightToolbar = true;\n  }\n\n  function handleHighlightCreated() {\n    showHighlightToolbar = false;\n    selectedText = '';\n    selectedRange = null;\n\n    // Clear selection\n    window.getSelection()?.removeAllRanges();\n  }\n\n  function handleCancelHighlight() {\n    showHighlightToolbar = false;\n    selectedText = '';\n    selectedRange = null;\n  }\n\n  $effect(() => {\n    if (contentElement && highlights.length > 0) {\n      applyHighlights();\n    }\n  });\n\n  // Recalculate avatar positions on resize\n  $effect(() => {\n    if (typeof window === 'undefined') return;\n\n    const handleResize = () => {\n      if (avatarData.length > 0) {\n        addHighlightAvatars();\n      }\n    };\n\n    window.addEventListener('resize', handleResize);\n\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  });\n\n  function applyHighlights() {\n    if (!contentElement) return;\n\n    // Reset any existing highlights and avatars\n    const existingMarks = contentElement.querySelectorAll('mark.nostr-highlight');\n    existingMarks.forEach(mark => {\n      const parent = mark.parentNode;\n      if (parent) {\n        parent.replaceChild(document.createTextNode(mark.textContent || ''), mark);\n        parent.normalize();\n      }\n    });\n\n    // Remove existing avatar containers\n    const existingAvatars = contentElement.querySelectorAll('.highlight-avatar-container');\n    existingAvatars.forEach(avatar => avatar.remove());\n\n    // Apply each highlight\n    highlights.forEach(highlight => {\n      const highlightText = highlight.content.trim();\n      if (!highlightText || !contentElement) return;\n\n      try {\n        highlightTextInElement(contentElement, highlightText, NDKHighlight.from(highlight));\n      } catch (err) {\n        console.warn('Failed to apply highlight:', err);\n      }\n    });\n\n    // Add avatars after all highlights are applied\n    addHighlightAvatars();\n  }\n\n  function highlightTextInElement(element: HTMLElement, searchText: string, highlightEvent: NDKHighlight) {\n    const walker = document.createTreeWalker(\n      element,\n      NodeFilter.SHOW_TEXT,\n      null\n    );\n\n    const nodesToHighlight: { node: Text; offset: number }[] = [];\n    let currentNode: Text | null;\n\n    while ((currentNode = walker.nextNode() as Text | null)) {\n      // Skip if parent is already a highlight\n      if (currentNode.parentElement?.classList.contains('nostr-highlight')) continue;\n\n      const text = currentNode.textContent || '';\n      const index = text.indexOf(searchText);\n\n      if (index !== -1) {\n        nodesToHighlight.push({ node: currentNode, offset: index });\n      }\n    }\n\n    // Apply highlights (do this after tree walk to avoid modifying while walking)\n    nodesToHighlight.forEach(({ node, offset }) => {\n      const text = node.textContent || '';\n      const before = text.substring(0, offset);\n      const highlighted = text.substring(offset, offset + searchText.length);\n      const after = text.substring(offset + searchText.length);\n\n      const mark = document.createElement('mark');\n      mark.className = 'nostr-highlight';\n      mark.dataset.pubkey = highlightEvent.pubkey;\n      mark.dataset.highlightId = highlightEvent.id;\n      mark.textContent = highlighted;\n\n      // Add click handler if callback is provided\n      if (onHighlightClick) {\n        mark.addEventListener('click', (e) => {\n          e.stopPropagation();\n          e.preventDefault();\n          onHighlightClick(highlightEvent);\n        });\n      }\n\n      const parent = node.parentNode;\n      if (parent) {\n        if (before) parent.insertBefore(document.createTextNode(before), node);\n        parent.insertBefore(mark, node);\n        if (after) parent.insertBefore(document.createTextNode(after), node);\n        parent.removeChild(node);\n      }\n    });\n  }\n\n  function addHighlightAvatars() {\n    if (!contentElement) return;\n\n    const marks = contentElement.querySelectorAll('mark.nostr-highlight');\n    const containerRect = contentElement.getBoundingClientRect();\n\n    // Group marks by their containing block element\n    const blockMap = new SvelteMap<HTMLElement, Set<string>>();\n\n    marks.forEach(mark => {\n      // Find the containing block element (p, h1, h2, etc.)\n      let block = mark.parentElement;\n      while (block && block !== contentElement) {\n        const tagName = block.tagName.toLowerCase();\n        if (['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'blockquote', 'div'].includes(tagName)) {\n          break;\n        }\n        block = block.parentElement;\n      }\n\n      if (block && block !== contentElement) {\n        const pubkey = (mark as HTMLElement).dataset.pubkey;\n        if (pubkey) {\n          if (!blockMap.has(block)) {\n            blockMap.set(block, new Set());\n          }\n          blockMap.get(block)?.add(pubkey);\n        }\n      }\n    });\n\n    // Prepare avatar data for rendering with calculated positions\n    const newAvatarData: Array<{ pubkey: string; top: number; right: string }> = [];\n\n    blockMap.forEach((pubkeys, block) => {\n      const blockRect = block.getBoundingClientRect();\n      const topPosition = blockRect.top - containerRect.top;\n\n      // Add avatar data for each pubkey\n      Array.from(pubkeys).forEach((pubkey, position) => {\n        newAvatarData.push({\n          pubkey,\n          top: topPosition + (position * 40),\n          right: '-3rem'\n        });\n      });\n    });\n\n    avatarData = newAvatarData;\n  }\n</script>\n\n<div class=\"article-wrapper {className}\">\n  {#if hasMarkdown}\n    <div\n      bind:this={contentElement}\n      onmouseup={handleMouseUp}\n      role=\"article\"\n      tabindex=\"0\"\n      class=\"article-content prose prose-lg dark:prose-invert max-w-none select-text\"\n    >\n      {@html htmlContent}\n    </div>\n  {:else}\n    <div\n      bind:this={contentElement}\n      onmouseup={handleMouseUp}\n      role=\"article\"\n      tabindex=\"0\"\n      class=\"article-content text-lg leading-[1.8] whitespace-pre-wrap select-text\"\n      style=\"font-family: var(--font-serif);\"\n    >\n      {content}\n    </div>\n  {/if}\n\n  <!-- Floating avatars for highlights -->\n  {#each avatarData as { pubkey, top, right }, index (pubkey + index)}\n    <div\n      class=\"highlight-avatar\"\n      style=\"position: absolute; top: {top}px; right: {right};\"\n    >\n      <User.Root {ndk} {pubkey}>\n        <User.Avatar class=\"w-8 h-8 rounded-full ring-2 ring-background shadow-lg\" />\n      </User.Root>\n    </div>\n  {/each}\n</div>\n\n{#if showHighlightToolbar}\n  <HighlightToolbar\n    {ndk}\n    {article}\n    {selectedText}\n    {selectedRange}\n    onCreated={handleHighlightCreated}\n    onCancel={handleCancelHighlight}\n  />\n{/if}\n\n<style>\n  .article-wrapper {\n    position: relative;\n  }\n\n  .highlight-avatar {\n    pointer-events: auto;\n    z-index: 10;\n  }\n\n  .highlight-avatar:hover {\n    transform: scale(1.1);\n    transition: transform 0.2s;\n  }\n\n  :global(.article-content) {\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content h1) {\n    font-size: 1.875rem;\n    font-weight: 700;\n    margin-top: 3rem;\n    margin-bottom: 1.5rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  @media (min-width: 640px) {\n    :global(.article-content h1) {\n      font-size: 2.25rem;\n    }\n  }\n\n  :global(.article-content h2) {\n    font-size: 1.5rem;\n    font-weight: 700;\n    margin-top: 2.5rem;\n    margin-bottom: 1.25rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  @media (min-width: 640px) {\n    :global(.article-content h2) {\n      font-size: 1.875rem;\n    }\n  }\n\n  :global(.article-content h3) {\n    font-size: 1.25rem;\n    font-weight: 700;\n    margin-top: 2rem;\n    margin-bottom: 1rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  @media (min-width: 640px) {\n    :global(.article-content h3) {\n      font-size: 1.5rem;\n    }\n  }\n\n  /* Remove top margin from first heading */\n  :global(.article-content > h1:first-child),\n  :global(.article-content > h2:first-child),\n  :global(.article-content > h3:first-child),\n  :global(.article-content > h4:first-child),\n  :global(.article-content > h5:first-child),\n  :global(.article-content > h6:first-child) {\n    margin-top: 0;\n  }\n\n  :global(.article-content p) {\n    font-size: 1.125rem;\n    line-height: 1.8;\n    margin-bottom: 1.5rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content a) {\n    color: #2563eb;\n    text-decoration: underline;\n    text-underline-offset: 2px;\n    transition-property: color;\n    transition-duration: 150ms;\n  }\n\n  :global(.article-content a:hover) {\n    color: #1e40af;\n  }\n\n  @media (prefers-color-scheme: dark) {\n    :global(.article-content a) {\n      color: #60a5fa;\n    }\n    :global(.article-content a:hover) {\n      color: #93c5fd;\n    }\n  }\n\n  :global(.article-content img) {\n    width: 100%;\n    border-radius: 0.5rem;\n    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);\n    margin-top: 2rem;\n    margin-bottom: 2rem;\n  }\n\n  :global(.article-content ul) {\n    list-style-type: disc;\n    padding-left: 1.5rem;\n    margin-bottom: 1.5rem;\n    font-size: 1.125rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content ul > * + *) {\n    margin-top: 0.5rem;\n  }\n\n  :global(.article-content ol) {\n    list-style-type: decimal;\n    padding-left: 1.5rem;\n    margin-bottom: 1.5rem;\n    font-size: 1.125rem;\n    font-family: var(--font-serif);\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content ol > * + *) {\n    margin-top: 0.5rem;\n  }\n\n  :global(.article-content li) {\n    line-height: 1.8;\n  }\n\n  :global(.article-content blockquote) {\n    border-left-width: 4px;\n    padding-left: 1.5rem;\n    margin-top: 2rem;\n    margin-bottom: 2rem;\n    font-style: italic;\n    font-size: 1.25rem;\n    line-height: 1.8;\n    font-family: var(--font-serif);\n    border-color: var(--color-border);\n    color: var(--color-muted-foreground);\n  }\n\n  :global(.article-content code) {\n    padding-left: 0.375rem;\n    padding-right: 0.375rem;\n    padding-top: 0.125rem;\n    padding-bottom: 0.125rem;\n    border-radius: 0.25rem;\n    font-size: 0.875rem;\n    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;\n    background-color: var(--color-muted);\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content pre) {\n    margin-bottom: 1.5rem;\n    overflow: hidden;\n    border-radius: 0.5rem;\n  }\n\n  :global(.article-content pre code) {\n    display: block;\n    border-width: 1px;\n    border-radius: 0.5rem;\n    padding: 1rem;\n    overflow-x: auto;\n    font-size: 0.875rem;\n    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;\n    line-height: 1.625;\n    background-color: var(--color-background);\n    border-color: var(--color-border);\n  }\n\n  :global(.article-content hr) {\n    margin-top: 3rem;\n    margin-bottom: 3rem;\n    border-top-width: 1px;\n    border-color: var(--color-border);\n  }\n\n  :global(.article-content strong) {\n    font-weight: 700;\n    color: var(--color-foreground);\n  }\n\n  :global(.article-content em) {\n    font-style: italic;\n  }\n\n  /* Nostr highlight styles */\n  :global(mark.nostr-highlight) {\n    background-color: color-mix(in srgb, var(--color-primary) 20%, transparent);\n    border-bottom: 2px solid color-mix(in srgb, var(--color-primary) 60%, transparent);\n    color: var(--color-foreground);\n    transition-property: all;\n    transition-duration: 200ms;\n    cursor: pointer;\n    padding: 0.125rem 0;\n    pointer-events: auto;\n    user-select: none;\n  }\n\n  :global(mark.nostr-highlight:hover) {\n    background-color: color-mix(in srgb, var(--color-primary) 30%, transparent);\n    border-bottom-color: var(--color-primary);\n  }\n</style>\n","type":"registry:ui","target":"article-content/article-content.svelte"},{"content":"<!-- @ndk-version: article-content@0.3.0 -->\n<script lang=\"ts\">\n  import { NDKHighlight, type NDKArticle } from '@nostr-dev-kit/ndk';\n  import type { NDKSvelte } from '@nostr-dev-kit/svelte';\n\n  interface Props {\n    ndk: NDKSvelte;\n    article: NDKArticle;\n    selectedText: string;\n    selectedRange: Range | null;\n    onCreated: () => void;\n    onCancel: () => void;\n  }\n\n  let { ndk, article, selectedText, selectedRange, onCreated, onCancel }: Props = $props();\n\n  let isCreating = $state(false);\n  let error = $state<string | null>(null);\n  let toolbarEl = $state<HTMLDivElement>();\n  let position = $state({ top: '0px', left: '0px', opacity: '0' });\n\n  // Update position when toolbar is mounted or range changes\n  $effect(() => {\n    if (selectedRange && toolbarEl) {\n      const rect = selectedRange.getBoundingClientRect();\n      const toolbarRect = toolbarEl.getBoundingClientRect();\n\n      // Position above the selection, centered\n      const left = rect.left + rect.width / 2 - toolbarRect.width / 2;\n      const top = rect.top - toolbarRect.height - 12; // 12px gap\n\n      position = {\n        top: `${top}px`,\n        left: `${left}px`,\n        opacity: '1'\n      };\n    }\n  });\n\n  async function createHighlight() {\n    if (!ndk.$currentUser) {\n      error = 'You must be logged in to create highlights';\n      return;\n    }\n\n    if (!selectedText.trim()) {\n      error = 'No text selected';\n      return;\n    }\n\n    isCreating = true;\n    error = null;\n\n    try {\n      const highlight = new NDKHighlight(ndk);\n      highlight.content = selectedText.trim();\n      highlight.article = article;\n\n      await highlight.publish();\n      onCreated();\n    } catch (err) {\n      error = err instanceof Error ? err.message : 'Failed to create highlight';\n      console.error('Failed to create highlight:', err);\n      isCreating = false;\n    }\n  }\n</script>\n\n{#if selectedRange}\n  <div\n    bind:this={toolbarEl}\n    class=\"fixed z-50 text-foreground rounded-lg shadow-xl border border-border overflow-hidden transition-opacity duration-150\"\n    style=\"top: {position.top}; left: {position.left}; opacity: {position.opacity};\"\n  >\n    {#if error}\n      <div class=\"px-4 py-2 bg-destructive/20 text-destructive text-sm border-b border-destructive/30\">\n        {error}\n      </div>\n    {/if}\n\n    <div class=\"flex items-center\">\n      <button\n        type=\"button\"\n        onclick={createHighlight}\n        disabled={isCreating}\n        class=\"flex items-center gap-2 px-4 py-3 hover:bg-muted transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n        title=\"Create highlight\"\n      >\n        {#if isCreating}\n          <svg class=\"w-5 h-5 animate-spin\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n          </svg>\n        {:else}\n          <svg class=\"w-5 h-5 text-warning\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 13h6m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n          </svg>\n        {/if}\n        <span class=\"text-sm font-medium\">Highlight</span>\n      </button>\n\n      <div class=\"w-px h-6 bg-border\"></div>\n\n      <button\n        type=\"button\"\n        onclick={onCancel}\n        class=\"px-3 py-3 hover:bg-muted transition-colors\"\n        title=\"Cancel\"\n        disabled={isCreating}\n      >\n        <svg class=\"w-5 h-5 text-muted-foreground\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\" />\n        </svg>\n      </button>\n    </div>\n\n    <!-- Arrow pointer -->\n    {#if toolbarEl}\n      <div\n        class=\"absolute left-1/2 -translate-x-1/2 pointer-events-none\"\n        style=\"bottom: -6px;\"\n      >\n        <div class=\"w-3 h-3 bg-card border-r border-b border-border rotate-45\"></div>\n      </div>\n    {/if}\n  </div>\n{/if}\n","type":"registry:ui","target":"article-content/highlight-toolbar.svelte"},{"content":"// @ndk-version: article-content@0.3.0\nexport { default as ArticleContent } from './article-content.svelte';\nexport { default as ArticleContentHighlightToolbar } from './highlight-toolbar.svelte';\n","type":"registry:lib","target":"article-content/index.ts"}],"version":"0.4.0","updatedAt":"2025-10-31T07:15:56.000Z"}