<!-- @ndk-version: mute-button@0.1.0 -->
<!--
  @component MuteButton
  Minimal mute button block using createMuteAction builder.
  Clean, icon-first design with dynamic text based on mute state.

  @example
  ```svelte
  <MuteButton {ndk} target={user} />
  <MuteButton {ndk} target={user} showIcon={false} />
  <MuteButton {ndk} target={user} showTarget={true} />
  ```
-->
<script lang="ts">
  import type { NDKUser } from '@nostr-dev-kit/ndk';
  import type { NDKSvelte } from '@nostr-dev-kit/svelte';
  import { createMuteAction } from '@nostr-dev-kit/svelte';
  import { getContext } from 'svelte';
  import { cn } from '../../../utils.js';
  import Avatar from '../user-profile/user-profile-avatar.svelte';
  import Name from '../user-profile/user-profile-name.svelte';

  interface Props {
    ndk?: NDKSvelte;
    target: NDKUser | string;
    showIcon?: boolean;
    showTarget?: boolean;
    class?: string;
  }

  let { ndk: ndkProp, target, showIcon = true, showTarget = false, class: className = '' }: Props = $props();

  const ndkContext = getContext<NDKSvelte>('ndk');
  const ndk = $derived(ndkProp || ndkContext);

  const isOwnProfile = $derived.by(() => {
    if (!ndk?.$currentPubkey || typeof target === 'string') return false;
    try {
      return ndk.$currentPubkey === (target as NDKUser).pubkey;
    } catch {
      return false;
    }
  });

  const muteAction = createMuteAction(() => ({ target }), ndk);

  async function handleToggle() {
    if (!ndk?.$currentPubkey) return;
    try {
      await muteAction.mute();
    } catch (error) {
      console.error('Failed to toggle mute:', error);
    }
  }
</script>

{#if !isOwnProfile && ndk?.$currentUser}
  <button
    type="button"
    onclick={handleToggle}
    class={cn(
      'inline-flex items-center gap-2 p-2 bg-transparent border-none cursor-pointer transition-colors',
      muteAction.isMuted ? 'text-red-500' : 'text-muted-foreground hover:text-foreground',
      className
    )}
    aria-label={muteAction.isMuted ? 'Unmute user' : 'Mute user'}
  >
    {#if showTarget && typeof target !== 'string'}
      <Avatar {ndk} user={target as NDKUser} size={20} />
      <span class="text-sm inline-flex items-baseline gap-1">
        <span class="font-bold">{muteAction.isMuted ? 'Unmute' : 'Mute'}</span>
        <Name {ndk} user={target as NDKUser} size="text-sm" class="font-normal" truncate={false} />
      </span>
    {:else}
      {#if showIcon}
        {#if muteAction.isMuted}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            class="flex-shrink-0"
          >
            <path d="M3 3L21 21" stroke-width="2" stroke-linecap="round" />
            <path d="M15 9C15.6254 9.6367 16 10.4906 16 11.4286C16 12.3666 15.6254 13.2205 15 13.8571M18 6C19.5 7.5 20 9.5 20 12C20 13.5 19.5 15 18.5 16.5" />
            <path d="M11 6.13481C11.3154 6.06028 11.65 6 12 6C14.2091 6 16 7.79086 16 10V14C16 16.2091 14.2091 18 12 18C11.65 18 11.3154 17.9397 11 17.8652V6.13481Z" />
            <path d="M6 10H4C2.89543 10 2 10.8954 2 12V12C2 13.1046 2.89543 14 4 14H6L11 18V6L9 7.6" />
          </svg>
        {:else}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            class="flex-shrink-0"
          >
            <path d="M15 9C15.6254 9.6367 16 10.4906 16 11.4286C16 12.3666 15.6254 13.2205 15 13.8571M18 6C19.5 7.5 20 9.5 20 12C20 14.5 19.5 16.5 18 18" />
            <path d="M12 6C14.2091 6 16 7.79086 16 10V14C16 16.2091 14.2091 18 12 18C11.65 18 11.3154 17.9397 11 17.8652V6.13481C11.3154 6.06028 11.65 6 12 6Z" />
            <path d="M6 10H4C2.89543 10 2 10.8954 2 12V12C2 13.1046 2.89543 14 4 14H6L11 18V6L6 10Z" />
          </svg>
        {/if}
      {/if}
      <span class="text-sm font-medium">
        {muteAction.isMuted ? 'Unmute' : 'Mute'}
      </span>
    {/if}
  </button>
{/if}
