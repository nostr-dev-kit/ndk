<script lang="ts">
  import { createReplyAction } from '$lib/registry/builders/reply-action.svelte.js';
  import type { NDKEvent } from '@nostr-dev-kit/ndk';
  import type { NDKSvelte } from '@nostr-dev-kit/svelte';

  interface Props {
    ndk: NDKSvelte;
    event: NDKEvent;
  }

  let { ndk, event }: Props = $props();

  // Create the reply action using the builder
  const replyAction = createReplyAction(() => ({ event }), ndk);

  // Local UI state
  let showComposer = $state(false);
  let replyContent = $state('');
  let isSubmitting = $state(false);

  async function handleSubmit() {
    if (!replyContent.trim() || isSubmitting) return;

    isSubmitting = true;
    try {
      await replyAction.reply(replyContent);
      replyContent = '';
      showComposer = false;
    } catch (error) {
      console.error('Failed to publish reply:', error);
    } finally {
      isSubmitting = false;
    }
  }

  function handleCancel() {
    showComposer = false;
    replyContent = '';
  }
</script>

<div class="space-y-3">
  <!-- Reply Button -->
  <button
    onclick={() => showComposer = !showComposer}
    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-border bg-background hover:bg-accent transition-colors"
  >
    <svg
      class="w-4 h-4 {replyAction.hasReplied ? 'text-primary' : 'text-muted-foreground'}"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
      />
    </svg>
    <span class="text-sm">{replyAction.count}</span>
  </button>

  {#if showComposer}
    <!-- Inline Composer -->
    <div class="border border-border rounded-lg p-4 bg-muted/50">
      <textarea
        bind:value={replyContent}
        placeholder="Write your reply..."
        class="w-full min-h-[100px] p-3 rounded-lg border border-border bg-background resize-y focus:outline-none focus:ring-2 focus:ring-primary"
      ></textarea>

      <div class="flex justify-end gap-2 mt-3">
        <button
          onclick={handleCancel}
          class="px-4 py-2 text-sm rounded-lg border border-border hover:bg-accent transition-colors"
        >
          Cancel
        </button>
        <button
          onclick={handleSubmit}
          disabled={!replyContent.trim() || isSubmitting}
          class="px-4 py-2 text-sm rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSubmitting ? 'Sending...' : 'Reply'}
        </button>
      </div>
    </div>
  {/if}
</div>
