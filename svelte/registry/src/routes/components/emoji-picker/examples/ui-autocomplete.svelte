<script lang="ts">
  import type { NDKSvelte, EmojiData } from '@nostr-dev-kit/svelte';
  import { createEmojiPicker } from '@nostr-dev-kit/svelte';
  import EventContent from '$lib/registry/components/event/content/event-content.svelte';

  interface Props {
    ndk: NDKSvelte;
  }

  let { ndk }: Props = $props();

  let textarea = $state<HTMLTextAreaElement>();
  let textareaContainer = $state<HTMLDivElement>();
  let text = $state('');
  let open = $state(false);
  let searchQuery = $state('');
  let selectedIndex = $state(0);
  let cursorPosition = $state(0);
  let colonPosition = $state(-1);
  let popoverPosition = $state({ top: 0, left: 0 });

  // Use emoji picker builder to get user's emojis
  const emojiState = createEmojiPicker(() => ({
    defaults: [{ emoji: "👍" }],
    from: ndk.$follows
  }), ndk);

  // Convert emojis to tags format for EventContent
  const emojiTags = $derived.by((): string[][] => {
    return emojiState.emojis
      .filter(emoji => emoji.shortcode && emoji.url)
      .map(emoji => ['emoji', emoji.shortcode!, emoji.url!]);
  });

  // Filter emojis based on search query
  const filteredEmojis = $derived.by((): EmojiData[] => {
    if (!searchQuery) return emojiState.emojis.slice(0, 10);

    const query = searchQuery.toLowerCase();
    return emojiState.emojis.filter(emoji =>
      emoji.shortcode?.toLowerCase().includes(query) ||
      emoji.emoji?.toLowerCase().includes(query)
    ).slice(0, 10);
  });

  function handleInput(e: Event) {
    const target = e.target as HTMLTextAreaElement;
    text = target.value;
    cursorPosition = target.selectionStart;

    // Find the last ":" before cursor
    const textBeforeCursor = text.slice(0, cursorPosition);
    const lastColonIndex = textBeforeCursor.lastIndexOf(':');

    if (lastColonIndex !== -1) {
      // Check if there's a space or we're at start before the colon
      const charBeforeColon = lastColonIndex === 0 ? ' ' : text[lastColonIndex - 1];
      const textAfterColon = textBeforeCursor.slice(lastColonIndex + 1);

      // Only show autocomplete if colon is at start or after whitespace
      // and there's no space after the colon
      if (/\s/.test(charBeforeColon) && !textAfterColon.includes(' ')) {
        colonPosition = lastColonIndex;
        searchQuery = textAfterColon;
        open = true;
        selectedIndex = 0;
        updatePopoverPosition();
      } else {
        open = false;
      }
    } else {
      open = false;
    }
  }

  function updatePopoverPosition() {
    if (!textarea) return;

    const rect = textarea.getBoundingClientRect();
    popoverPosition = {
      top: rect.bottom + 8,
      left: rect.left
    };
  }

  function handleKeyDown(e: KeyboardEvent) {
    if (!open || filteredEmojis.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = (selectedIndex + 1) % filteredEmojis.length;
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = selectedIndex === 0 ? filteredEmojis.length - 1 : selectedIndex - 1;
    } else if (e.key === 'Tab' || e.key === 'Enter') {
      e.preventDefault();
      insertEmoji(filteredEmojis[selectedIndex]);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      open = false;
    }
  }

  function insertEmoji(emoji: EmojiData) {
    if (!textarea || colonPosition === -1) return;

    // Replace :query with emoji
    const before = text.slice(0, colonPosition);
    const after = text.slice(cursorPosition);
    const emojiText = emoji.shortcode ? `:${emoji.shortcode}:` : emoji.emoji || '';

    text = before + emojiText + after;
    open = false;
    searchQuery = '';
    colonPosition = -1;

    // Set cursor after emoji
    setTimeout(() => {
      if (textarea) {
        const newCursorPos = before.length + emojiText.length;
        textarea.selectionStart = textarea.selectionEnd = newCursorPos;
        textarea.focus();
      }
    }, 0);
  }

  function handleEmojiClick(emoji: EmojiData) {
    insertEmoji(emoji);
  }
</script>

<div class="space-y-4">
  <div class="relative" bind:this={textareaContainer}>
    <textarea
      bind:this={textarea}
      bind:value={text}
      oninput={handleInput}
      onkeydown={handleKeyDown}
      class="w-full min-h-32 p-3 border rounded-lg bg-background resize-y focus:outline-none focus:ring-2 focus:ring-primary"
      placeholder="Type : to search for emojis..."
    ></textarea>

    {#if open}
      <div
        class="fixed z-50 w-full max-w-md rounded-lg border bg-card shadow-lg overflow-hidden"
        style="top: {popoverPosition.top}px; left: {popoverPosition.left}px;"
      >
        <div class="max-h-64 overflow-y-auto p-2">
          {#if filteredEmojis.length === 0}
            <div class="px-3 py-2 text-sm text-muted-foreground">No emojis found</div>
          {:else}
            {#each filteredEmojis as emoji, index}
              <button
                class="w-full flex items-center gap-3 px-3 py-2 rounded-md hover:bg-accent transition-colors text-left"
                class:bg-accent={index === selectedIndex}
                onclick={() => handleEmojiClick(emoji)}
                onmouseenter={() => selectedIndex = index}
              >
                <div class="flex items-center justify-center w-6 h-6 flex-shrink-0">
                  {#if emoji.url}
                    <img src={emoji.url} alt={emoji.shortcode} class="w-full h-full object-contain" />
                  {:else}
                    <span class="text-xl">{emoji.emoji}</span>
                  {/if}
                </div>
                <span class="text-sm font-mono text-muted-foreground">:{emoji.shortcode || emoji.emoji}:</span>
              </button>
            {/each}
          {/if}
        </div>
        <div class="border-t px-3 py-2 text-xs text-muted-foreground bg-muted/50">
          <span class="font-medium">Tab</span> or <span class="font-medium">Enter</span> to select · <span class="font-medium">Esc</span> to close
        </div>
      </div>
    {/if}
  </div>

  {#if text}
    <div class="border rounded-lg p-4 bg-card">
      <div class="text-xs font-semibold text-muted-foreground mb-2 uppercase tracking-wide">Preview</div>
      <EventContent {ndk} content={text} {emojiTags} />
    </div>
  {/if}

  <div class="text-sm text-muted-foreground">
    <p>Type <code class="px-1.5 py-0.5 rounded bg-muted font-mono">:</code> followed by text to search your emojis</p>
    <p class="mt-1">Use arrow keys to navigate, Tab/Enter to select, Esc to close</p>
  </div>
</div>
