<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Duplicate Filters</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #log {
            background: #000;
            padding: 20px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
        }
        .header {
            color: #ffff00;
            font-weight: bold;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .info {
            color: #00ffff;
        }
    </style>
</head>
<body>
    <h1>NDK Duplicate Filter Test</h1>
    <div id="log"></div>

    <script type="module">
        import { NDKSvelte } from './dist/index.js';

        const logDiv = document.getElementById('log');

        function log(message, className = '') {
            const line = document.createElement('div');
            line.className = className;
            line.textContent = message;
            logDiv.appendChild(line);
            console.log(message);
        }

        async function runTest() {
            log('=== Testing duplicate filter issue ===', 'header');
            log('');

            // Create NDK with outbox disabled and single explicit relay
            log('Creating NDK with:');
            log('  - explicitRelayUrls: ["wss://relay.nostr.band"]');
            log('  - enableOutboxModel: false');
            log('');

            const ndk = new NDKSvelte({
                explicitRelayUrls: ['wss://relay.nostr.band'],
                enableOutboxModel: false,
            });

            // Make ndk global for debugging
            window.ndk = ndk;

            // Connect to the explicit relay
            log('Connecting to relay.nostr.band...', 'info');
            await ndk.connect();

            // Wait for connection
            await new Promise(resolve => setTimeout(resolve, 1000));
            log('Connected!', 'success');
            log('');

            log('=== Creating subscription ===', 'header');
            log('Filter: { kinds: [1], limit: 1 }');
            log('Relay URLs: ["wss://relay.nostr.band", "wss://f7z.io"]');
            log('closeOnEose: false');
            log('');

            // Create subscription with specific relay URLs
            const subscription = ndk.$subscribe(() => ({
                filters: { kinds: [1], limit: 1 },
                relayUrls: ['wss://relay.nostr.band', 'wss://f7z.io'],
                closeOnEose: false,
                groupable: false, // Try with groupable false
            }));

            // Make subscription global for debugging
            window.subscription = subscription;

            // Start the subscription
            log('Starting subscription...', 'info');
            subscription.start();

            // Monitor for a few seconds
            log('');
            log('=== Monitoring for 5 seconds ===', 'header');
            log('Check browser console for [compileFilters] and [addItem] logs');
            log('');

            let lastCount = 0;
            const interval = setInterval(() => {
                if (subscription.count !== lastCount) {
                    log(`Events received: ${subscription.count}`, 'success');
                    lastCount = subscription.count;
                }
            }, 500);

            await new Promise(resolve => setTimeout(resolve, 5000));
            clearInterval(interval);

            log('');
            log('=== Final Status ===', 'header');
            log(`Events received: ${subscription.count}`);
            log(`EOSED: ${subscription.eosed}`);
            log('');

            log('=== Test Complete ===', 'header');
            log('Check browser console for:');
            log('1. [compileFilters] logs showing items.size');
            log('2. [addItem] logs showing when subscriptions are added');
            log('3. Final mergedFilters showing if filters are duplicated');
            log('');
            log('You can also inspect:');
            log('  window.ndk - the NDK instance');
            log('  window.subscription - the subscription object');

            // Also log to console for easy copying
            console.log('\n=== IMPORTANT: Check for duplicate filters in REQ messages ===');
            console.log('Open Network tab and look for WebSocket messages');
            console.log('The REQ message should have the filter ONCE, not duplicated');
        }

        // Run the test
        runTest().catch(err => {
            log(`Error: ${err.message}`, 'error');
            console.error(err);
        });
    </script>
</body>
</html>